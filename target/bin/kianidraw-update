#!/bin/sh
PROG_NAME=$(basename $0)
MSG_PREFIX="$PROG_NAME[$(basename "$(pwd)")]"
. /usr/local/lib/kianidraw-common

is_structure_ok || exit_bad_location "$PROG_NAME"

USAGE="Usage: $PROG_NAME resources/(all|<resourceName>)"

test -n "$1" || exit_bad_args "$USAGE"

class=$(expr "$1" : '\([^/]*\)')
item=$(expr "$1" : '[^/]*/\(.*\)' | sed 's/\//\\\//g')

convert_xcf_to_pngs() {
	infile=$1
	outfiles_dir=$2

	{
		cat <<END
def convert(infile, outfiles_dir):
	img = pdb.gimp_file_load(infile, infile)
	for layer in img.layers:
		outfile = outfiles_dir + "/" + layer.name + ".png"
		print(layer.name)
		pdb.gimp_file_save(img, layer, outfile, outfile)
	pdb.gimp_image_delete(img)
END
		echo "convert(\"$infile\", \"$outfiles_dir\")"
		echo "pdb.gimp_quit(1)"
	} | gimp -i --batch-interpreter=python-fu-eval -b -
}

process_resource() {
	resource=$1

	echo "$MSG_PREFIX: processing elements for \"$resource\" â€¦"
	rm -f $INTERNAL_IN_D/$resource.d/*.png
	convert_xcf_to_pngs $INTERNAL_IN_D/$resource.d/$resource.xcf $INTERNAL_IN_D/$resource.d
}

case $class in
resources)
	test -n "$item" || exit_bad_args "$USAGE"

	test X"$item" = Xall && {
		kianidraw-get resources | while read r; do
			process_resource $r
		done
		exit
	}

	kianidraw-get resources/"$item" >/dev/null 2>&1 \
	|| exit_error "$MSG_PREFIX: resources/\"$item\": not found"

	process_resource $item
	;;
*)
	exit_bad_args "$USAGE"
esac
