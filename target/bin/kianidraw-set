#!/bin/sh
PROG_NAME=$(basename $0)
MSG_PREFIX="$PROG_NAME[$(basename "$(pwd)")]"
. /usr/local/lib/kianidraw-common

is_structure_ok || exit_bad_location "$PROG_NAME"

USAGE="\
Usage: $PROG_NAME config/<property> <value>|default
       $PROG_NAME config/all default"

test $# -eq 2 || exit_bad_args "$USAGE"

class=$(expr "$1" : '\([^/]*\)')
item=$(expr "$1" : '[^/]*/\(.*\)' | sed 's/\//\\\//g')
value=$2

delete_config_line() {
	_line=$1

	awk "!/$_line/ {print}" $INTERNAL_CONFIG > $INTERNAL_CONFIG.tmp
	rm $INTERNAL_CONFIG
	mv $INTERNAL_CONFIG.tmp $INTERNAL_CONFIG
}

check_config_value() {
	_item=$1
	_value=$2

	_pattern=$(eval echo \$CONFIG_${_item}_PATTERN)
	_pattern=${_pattern:-$CONFIG_PROP_VALUE_PATTERN}

	expr "$_value" : "$_pattern\$" >/dev/null
}

case $class in
config)
	test -n "$item" || exit_bad_args "$USAGE"

	test X"$item" = Xall && {
		case $value in
		default)
			> $INTERNAL_CONFIG
			echo "$MSG_PREFIX: deleted local config"
			exit
			;;
		*)
			exit_bad_args "$USAGE"
		esac
	}

	expr "$item" : "$CONFIG_PROP_NAME_PATTERN\$" >/dev/null \
	|| exit_error "$MSG_PREFIX: config/\"$item\": bad property name format"

	old_value=$(kianidraw-get config/$item 2>/dev/null)

	case $value in
	default)
		test -n "$old_value" \
		|| exit_error "$MSG_PREFIX: config/\"$item\": unknown, default value not available"

		delete_config_line "^$item=$old_value\$"
		echo "$MSG_PREFIX: deleted \"$item\" from local config"
		;;
	*)
		check_config_value $item "$value" \
		|| exit_error "$MSG_PREFIX: config/$item: \"$value\": bad value format"

		delete_config_line "^$item=$old_value\$"
		echo "$item=$value" >> $INTERNAL_CONFIG
		echo "$MSG_PREFIX: updated local config with \"$item=$value\""
	esac
	;;
*)
	exit_bad_args "$USAGE"
esac
