#!/bin/sh
PROG_NAME=$(basename $0)
MSG_PREFIX="$PROG_NAME[$(basename "$(pwd)")]"

exit_bad_location() {
	echo "$PROG_NAME: not in a valid/usable kianidraw project" >&2
	exit 1
}

for flag in d r w; do
	test -$flag .kianidraw/in || exit_bad_location
	test -$flag in            || exit_bad_location
done

move=false
test X"$1" = X"-m" && {
	move=true
	shift
}

test $# -ge 2 && test $(expr $# % 2) -eq 0 || {
	echo "$MSG_PREFIX: at least 2 args required per imported resource: (<file> <name>)..." >&2
	exit 64
}

while test $# -gt 0; do
	test -r "$1" || {
		echo "$MSG_PREFIX: warning: \"$1\" is not a readable file => skipped" >&2
		shift 2
		continue
	}

	sum=$(cksum "$1" | awk '{print $1}')
	! $(ls -A in | grep -q $sum) || {
		echo "$MSG_PREFIX: warning: \"$1\" already imported => skipped" >&2
		shift 2
		continue
	}

	! expr "$2" : "\." >/dev/null || {
		echo "$MSG_PREFIX: warning: bad name: \"$2\" => skipped" >&2
		shift 2
		continue
	}

	! test -f .kianidraw/in/"$2" || {
		echo "$MSG_PREFIX: warning: name \"$2\" already in use => skipped" >&2
		shift 2
		continue
	}

	new_filename=${sum}_$(basename $1)

	if $move; then
		mv "$1" in/"$new_filename"
	else
		cp "$1" in/"$new_filename"
	fi
	ln -s ../../in/"$new_filename" .kianidraw/in/"$2"

	sleep 1
	echo "$MSG_PREFIX: imported \"$1\" as \"$2\""
	shift 2
done
